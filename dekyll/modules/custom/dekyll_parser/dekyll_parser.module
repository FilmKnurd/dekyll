<?php

/**
 * Define the YAML front header separator.
 */
define('YAML_SEPARATOR', "---\n");

/**
 * @file
 * Read and Write Jekyll files.
 */
require DRUPAL_ROOT . '/profiles/dekyll/libraries/vendor/autoload.php';

use GitWrapper\GitWrapper;
use Symfony\Component\Finder\Finder;
use Symfony\Component\Yaml\Parser;
use Symfony\Component\Yaml\Dumper;

function dekyll_parser_init() {
  $wrapper = new GitWrapper();

  $path = variable_get('file_public_path', conf_path() . '/files') . '/git';

  $git = $wrapper->workingCopy($path);
  if (!$git->isCloned()) {
    $git->clone('git@github.com:amitaibu/jekyll-bootstrap.git');
  }

  // Find files.
  $finder = new Finder();
  $finder
    ->files()
    ->in($path)
    // @todo: Exclude directories with underscore except of _posts and _drafts
    ->notPath('/^_.*|!_posts|!_drafts/')
    ->notPath('assets');


  foreach ($finder as $file) {
    if ($file->getFilename() === 'archive.html') {
      $contents = $file->getContents();

      // Get the values from the YAML front header.
      $split_contents = explode(YAML_SEPARATOR, $contents, 3);
      $yaml_contents = $split_contents[1];
      $text = $split_contents[2];

      $yaml = new Parser();
      $yaml_parsed = $yaml->parse($yaml_contents);

      $yaml_parsed['title'] .= time();

      $dumper = new Dumper();


      $dump = array(
        YAML_SEPARATOR,
        $dumper->dump($yaml_parsed) . "\n",
        YAML_SEPARATOR,
        $text,
      );

      dpm(implode('', $dump));

      // file_put_contents($file->getRealpath(), implode('', $dump));
      return;
    }
  }

}
